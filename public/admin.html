<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Tselot Tunes - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#d4af35",
                        "background-light": "#f8f7f6",
                        "background-dark": "#201d12",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
        }
        body { background: #201d12; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
    <div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden">
        <div class="flex h-full min-h-screen">
            <!-- SideNavBar -->
            <div id="sidebar" class="hidden flex-col border-r border-white/10 bg-[#201d13] p-4 w-64">
                <div class="flex flex-col gap-4 h-full">
                    <div class="flex gap-3 items-center">
                        <div class="bg-gradient-to-br from-primary to-yellow-600 rounded-full size-10"></div>
                        <div class="flex flex-col">
                            <h1 class="text-white text-base font-medium">Tselot Tunes</h1>
                            <p class="text-white/60 text-sm">Admin Panel</p>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 mt-6">
                        <div id="nav-mezmurs" class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 cursor-pointer">
                            <span class="material-symbols-outlined text-primary text-xl">music_note</span>
                            <p class="text-primary text-sm font-bold">Mezmurs</p>
                        </div>
                        <div id="nav-wallpapers" class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 cursor-pointer">
                            <span class="material-symbols-outlined text-white/80 text-xl">image</span>
                            <p class="text-white/80 text-sm font-medium">Wallpapers</p>
                        </div>
                        <div id="nav-ringtones" class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 cursor-pointer">
                            <span class="material-symbols-outlined text-white/80 text-xl">ring_volume</span>
                            <p class="text-white/80 text-sm font-medium">Ringtones</p>
                        </div>
                        <div id="nav-stats" class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 cursor-pointer">
                            <span class="material-symbols-outlined text-white/80 text-xl">bar_chart</span>
                            <p class="text-white/80 text-sm font-medium">Statistics</p>
                        </div>
                    </div>
                    <div class="mt-auto">
                        <button id="sidebarLogoutBtn" class="w-full py-2 px-4 rounded-lg bg-primary text-[#201d13] text-sm font-bold cursor-pointer mt-2">Logout</button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <main class="flex-1 p-8">
                <!-- Login Section -->
                <div id="loginSection" class="max-w-md mx-auto mt-20">
                    <div class="bg-[#2b281c] rounded-lg border border-white/20 p-8">
                        <div class="text-center mb-8">
                            <div class="bg-gradient-to-br from-primary to-yellow-600 rounded-full size-16 mx-auto mb-4 flex items-center justify-center">
                                <span class="material-symbols-outlined text-[#201d13] text-3xl">lock</span>
                            </div>
                            <h2 class="text-white text-2xl font-bold mb-2">Admin Login</h2>
                            <p class="text-white/60 text-sm">Sign in to manage your content</p>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-white/80 text-sm font-medium mb-2">Email</label>
                                <input type="email" id="email" class="w-full px-4 py-2 bg-[#201d13] border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary" placeholder="admin@tselottunes.com">
                            </div>
                            <div>
                                <label class="block text-white/80 text-sm font-medium mb-2">Password</label>
                                <input type="password" id="password" class="w-full px-4 py-2 bg-[#201d13] border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                            </div>
                            <button id="loginBtn" class="w-full py-3 px-4 rounded-lg font-bold cursor-pointer bg-primary text-[#201d13] hover:bg-yellow-500 transition-colors">Login</button>
                            <div id="loginError" class="text-red-400 text-sm hidden mt-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Main Content (Hidden until login) -->
                <div id="mainContent" class="hidden max-w-7xl mx-auto">
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                        <div class="flex flex-col gap-2">
                            <p id="pageTitle" class="text-white text-4xl font-black">Mezmur Management</p>
                            <p id="pageSubtitle" class="text-white/60 text-base">Manage all the mezmurs in the Tselot Tunes app.</p>
                        </div>
                        <button id="addItemBtn" class="flex items-center justify-center rounded-lg h-10 px-4 bg-primary text-[#201d13] text-sm font-bold gap-2 cursor-pointer">
                            <span class="material-symbols-outlined">add</span>
                            <span>Add Mezmur</span>
                        </button>
                    </div>

                    <!-- Tabs -->
                    <div id="tabsContainer" class="pb-3 mb-6">
                        <div class="flex border-b border-white/20 gap-8">
                            <a id="tab-all" class="tab-link flex flex-col items-center border-b-[3px] border-b-primary text-white pb-[13px] pt-4 cursor-pointer">
                                <p class="text-sm font-bold">All</p>
                            </a>
                            <a id="tab-zema" class="tab-link flex flex-col items-center border-b-[3px] border-b-transparent text-white/60 hover:text-white pb-[13px] pt-4 cursor-pointer">
                                <p class="text-sm font-bold">Zema</p>
                            </a>
                            <a id="tab-wazema" class="tab-link flex flex-col items-center border-b-[3px] border-b-transparent text-white/60 hover:text-white pb-[13px] pt-4 cursor-pointer">
                                <p class="text-sm font-bold">Wazema</p>
                            </a>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div id="mezmursTab" class="tab-content">
                        <div class="flex overflow-hidden rounded-lg border border-white/20 bg-[#2b281c]">
                            <table class="flex-1 w-full">
                                <thead>
                                    <tr class="bg-white/5">
                                        <th class="px-4 py-3 text-left text-white/80 w-14 text-sm font-medium">Image</th>
                                        <th class="px-4 py-3 text-left text-white/80 text-sm font-medium">Title</th>
                                        <th class="px-4 py-3 text-left text-white/80 text-sm font-medium">Artist</th>
                                        <th class="px-4 py-3 text-left text-white/80 text-sm font-medium">Category</th>
                                        <th class="px-4 py-3 text-left text-white/80 text-sm font-medium">Plays</th>
                                        <th class="px-4 py-3 text-left text-white/80 text-sm font-medium">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="mezmursList">
                                    <tr><td colspan="6" class="px-4 py-8 text-center text-white/60">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="wallpapersTab" class="tab-content hidden">
                        <div id="wallpapersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="text-center text-white/60 py-8">Loading...</div>
                        </div>
                    </div>

                    <div id="ringtonesTab" class="tab-content hidden">
                        <div class="flex overflow-hidden rounded-lg border border-white/20 bg-[#2b281c]">
                            <table class="flex-1 w-full">
                                <thead>
                                    <tr class="bg-white/5">
                                        <th class="px-4 py-3 text-left text-white/80 text-sm font-medium">Image</th>
                                        <th class="px-4 py-3 text-left text-white/80 text-sm font-medium">Title</th>
                                        <th class="px-4 py-3 text-left text-white/80 text-sm font-medium">Artist</th>
                                        <th class="px-4 py-3 text-left text-white/80 text-sm font-medium">Category</th>
                                        <th class="px-4 py-3 text-left text-white/80 text-sm font-medium">Downloads</th>
                                        <th class="px-4 py-3 text-left text-white/80 text-sm font-medium">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ringtonesList">
                                    <tr><td colspan="6" class="px-4 py-8 text-center text-white/60">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="statsTab" class="tab-content hidden">
                        <div id="statsContent" class="text-center text-white/60 py-8">Loading...</div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script>
        let API_URL = window.location.protocol === 'file:' || window.location.hostname === 'localhost' ? 'https://mezmurtege.onrender.com' : window.location.origin;
        let authToken = localStorage.getItem('auth_token');
        let currentTab = 'mezmurs';

        function getHeaders(includeAuth = true) {
            const headers = { 'Content-Type': 'application/json' };
            if (includeAuth && authToken) headers['Authorization'] = `Bearer ${authToken}`;
            return headers;
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function updatePageTitle(title, subtitle) {
            document.getElementById('pageTitle').textContent = title;
            document.getElementById('pageSubtitle').textContent = subtitle;
            const btn = document.getElementById('addItemBtn').querySelector('span:last-child');
            if (title.includes('Mezmur')) btn.textContent = 'Add Mezmur';
            else if (title.includes('Wallpaper')) btn.textContent = 'Add Wallpaper';
            else if (title.includes('Ringtone')) btn.textContent = 'Add Ringtone';
        }

        function updateNavActive(tab) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-primary/20');
                item.querySelector('p').classList.remove('text-primary', 'font-bold');
                item.querySelector('p').classList.add('text-white/80', 'font-medium');
                item.querySelector('span').classList.remove('text-primary');
                item.querySelector('span').classList.add('text-white/80');
            });
            const nav = document.getElementById(`nav-${tab}`);
            if (nav) {
                nav.classList.add('bg-primary/20');
                nav.querySelector('p').classList.remove('text-white/80', 'font-medium');
                nav.querySelector('p').classList.add('text-primary', 'font-bold');
                nav.querySelector('span').classList.remove('text-white/80');
                nav.querySelector('span').classList.add('text-primary');
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            if (!email || !password) {
                errorDiv.textContent = 'Please enter email and password';
                errorDiv.classList.remove('hidden');
                return;
            }
            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: getHeaders(false),
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (data.success && data.token) {
                    authToken = data.token;
                    localStorage.setItem('auth_token', authToken);
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                    document.getElementById('sidebar').classList.remove('hidden');
                    errorDiv.classList.add('hidden');
                    loadContent();
                } else {
                    errorDiv.textContent = data.error || 'Login failed';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Connection error: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        function logout() {
            authToken = null;
            localStorage.removeItem('auth_token');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('sidebar').classList.add('hidden');
        }

        function showTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
            updateNavActive(tabName);
            if (tabName === 'mezmurs') {
                updatePageTitle('Mezmur Management', 'Manage all the mezmurs in the Tselot Tunes app.');
                document.getElementById('tabsContainer').classList.remove('hidden');
            } else if (tabName === 'wallpapers') {
                updatePageTitle('Wallpaper Management', 'Manage all the wallpapers in the Tselot Tunes app.');
                document.getElementById('tabsContainer').classList.add('hidden');
            } else if (tabName === 'ringtones') {
                updatePageTitle('Ringtone Management', 'Manage all the ringtones in the Tselot Tunes app.');
                document.getElementById('tabsContainer').classList.add('hidden');
            } else if (tabName === 'stats') {
                updatePageTitle('Statistics', 'View app statistics and analytics.');
                document.getElementById('tabsContainer').classList.add('hidden');
            }
            loadContent();
        }

        async function loadContent() {
            if (currentTab === 'mezmurs') await loadMezmurs();
            else if (currentTab === 'wallpapers') await loadWallpapers();
            else if (currentTab === 'ringtones') await loadRingtones();
            else if (currentTab === 'stats') await loadStats();
        }

        async function loadMezmurs() {
            const tbody = document.getElementById('mezmursList');
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-white/60">Loading...</td></tr>';
            try {
                const response = await fetch(`${API_URL}/api/mezmurs`, { headers: getHeaders() });
                const data = await response.json();
                if (data.success && data.data && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(m => `
                        <tr class="border-t border-t-white/20 hover:bg-white/5">
                            <td class="h-[72px] px-4 py-2"><div class="bg-center bg-cover rounded-lg w-10 h-10" style="background-image:url('${m.imageUrl||'https://via.placeholder.com/40'}')"></div></td>
                            <td class="h-[72px] px-4 py-2 text-white text-sm">${m.title||'N/A'}</td>
                            <td class="h-[72px] px-4 py-2 text-white/60 text-sm">${m.artist||'Unknown'}</td>
                            <td class="h-[72px] px-4 py-2"><div class="inline-flex rounded-full py-1 px-3 bg-primary/20 text-primary text-xs font-medium">${m.category||'All'}</div></td>
                            <td class="h-[72px] px-4 py-2 text-white/60 text-sm">${formatNumber(m.plays||0)}</td>
                            <td class="h-[72px] px-4 py-2"><button class="delete-mezmur-btn text-red-400 hover:text-red-300 cursor-pointer" data-id="${m._id}"><span class="material-symbols-outlined">delete</span></button></td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-white/60">No mezmurs found.</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-red-400">Error: ${error.message}</td></tr>`;
            }
        }

        async function loadWallpapers() {
            const div = document.getElementById('wallpapersList');
            div.innerHTML = '<div class="col-span-full text-center text-white/60 py-8">Loading...</div>';
            try {
                const response = await fetch(`${API_URL}/api/wallpapers`, { headers: getHeaders() });
                const data = await response.json();
                if (data.success && data.data && data.data.length > 0) {
                    div.innerHTML = data.data.map(w => `
                        <div class="bg-[#2b281c] rounded-lg border border-white/20 overflow-hidden">
                            <div class="bg-cover aspect-video" style="background-image:url('${w.imageUrl||'https://via.placeholder.com/400'}')"></div>
                            <div class="p-4">
                                <h3 class="text-white font-semibold text-sm mb-1">${w.title||'Untitled'}</h3>
                                <p class="text-white/60 text-xs mb-2">${w.category||'Uncategorized'}</p>
                                <p class="text-white/40 text-xs mb-3">Downloads: ${formatNumber(w.downloads||0)}</p>
                                <button class="delete-wallpaper-btn w-full px-3 py-2 bg-red-600/20 hover:bg-red-600/30 text-red-400 rounded text-xs cursor-pointer" data-id="${w._id}">Delete</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    div.innerHTML = '<div class="col-span-full text-center text-white/60 py-8">No wallpapers found.</div>';
                }
            } catch (error) {
                div.innerHTML = `<div class="col-span-full text-center text-red-400 py-8">Error: ${error.message}</div>`;
            }
        }

        async function loadRingtones() {
            const tbody = document.getElementById('ringtonesList');
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-white/60">Loading...</td></tr>';
            try {
                const response = await fetch(`${API_URL}/api/ringtones`, { headers: getHeaders() });
                const data = await response.json();
                if (data.success && data.data && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(r => `
                        <tr class="border-t border-t-white/20 hover:bg-white/5">
                            <td class="h-[72px] px-4 py-2"><div class="bg-cover rounded-lg w-10 h-10" style="background-image:url('${r.thumbnailUrl||'https://via.placeholder.com/40'}')"></div></td>
                            <td class="h-[72px] px-4 py-2 text-white text-sm">${r.title||'N/A'}</td>
                            <td class="h-[72px] px-4 py-2 text-white/60 text-sm">${r.artist||'Unknown'}</td>
                            <td class="h-[72px] px-4 py-2"><div class="inline-flex rounded-full py-1 px-3 bg-primary/20 text-primary text-xs font-medium">${r.category||'All'}</div></td>
                            <td class="h-[72px] px-4 py-2 text-white/60 text-sm">${formatNumber(r.downloads||0)}</td>
                            <td class="h-[72px] px-4 py-2"><button class="delete-ringtone-btn text-red-400 hover:text-red-300 cursor-pointer" data-id="${r._id}"><span class="material-symbols-outlined">delete</span></button></td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-white/60">No ringtones found.</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-red-400">Error: ${error.message}</td></tr>`;
            }
        }

        async function loadStats() {
            const div = document.getElementById('statsContent');
            div.innerHTML = '<div class="text-center text-white/60 py-8">Loading...</div>';
            try {
                const response = await fetch(`${API_URL}/api/statistics/overview`, { headers: getHeaders() });
                const data = await response.json();
                if (data.success && data.data) {
                    const s = data.data;
                    div.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-[#2b281c] border border-white/20 rounded-lg p-6">
                                <h3 class="text-3xl font-bold mb-2 text-primary">${s.counts?.mezmurs||0}</h3>
                                <p class="text-white/60">Total Mezmurs</p>
                            </div>
                            <div class="bg-[#2b281c] border border-white/20 rounded-lg p-6">
                                <h3 class="text-3xl font-bold mb-2 text-primary">${s.counts?.wallpapers||0}</h3>
                                <p class="text-white/60">Total Wallpapers</p>
                            </div>
                            <div class="bg-[#2b281c] border border-white/20 rounded-lg p-6">
                                <h3 class="text-3xl font-bold mb-2 text-primary">${s.counts?.ringtones||0}</h3>
                                <p class="text-white/60">Total Ringtones</p>
                            </div>
                        </div>
                        <div class="bg-[#2b281c] border border-white/20 rounded-lg p-6">
                            <h3 class="font-bold mb-4 text-lg text-primary">Mezmur Statistics</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div><p class="text-white/60 text-sm mb-1">Total Plays</p><p class="text-2xl font-bold text-white">${formatNumber(s.mezmurs?.totalPlays||0)}</p></div>
                                <div><p class="text-white/60 text-sm mb-1">Total Downloads</p><p class="text-2xl font-bold text-white">${formatNumber(s.mezmurs?.totalDownloads||0)}</p></div>
                                <div><p class="text-white/60 text-sm mb-1">Total Favorites</p><p class="text-2xl font-bold text-white">${formatNumber(s.mezmurs?.totalFavorites||0)}</p></div>
                                <div><p class="text-white/60 text-sm mb-1">Total Shares</p><p class="text-2xl font-bold text-white">${formatNumber(s.mezmurs?.totalShares||0)}</p></div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                div.innerHTML = `<div class="text-red-400 text-center py-8">Error: ${error.message}</div>`;
            }
        }

        function showAddMezmurForm() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-[#2b281c] border border-white/20 rounded-lg p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-white text-xl font-bold">Add New Mezmur</h3>
                        <button id="closeModal" class="text-white/60 hover:text-white cursor-pointer">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <form id="mezmurForm" class="space-y-4">
                        <div>
                            <label class="block text-white/80 text-sm font-medium mb-2">Title *</label>
                            <input type="text" id="formTitle" required class="w-full px-4 py-2 bg-[#201d13] border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary" placeholder="Mezmur Title">
                        </div>
                        <div>
                            <label class="block text-white/80 text-sm font-medium mb-2">Artist *</label>
                            <input type="text" id="formArtist" required class="w-full px-4 py-2 bg-[#201d13] border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary" placeholder="Artist Name">
                        </div>
                        <div>
                            <label class="block text-white/80 text-sm font-medium mb-2">Category</label>
                            <select id="formCategory" class="w-full px-4 py-2 bg-[#201d13] border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary">
                                <option value="All">All</option>
                                <option value="Kidase">Kidase</option>
                                <option value="Holiday">Holiday</option>
                                <option value="Sunday">Sunday</option>
                                <option value="Saints">Saints</option>
                                <option value="Fasting">Fasting</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-white/80 text-sm font-medium mb-2">Image (File or URL)</label>
                            <input type="file" id="formImageFile" accept="image/*" class="w-full px-4 py-2 bg-[#201d13] border border-white/10 rounded-lg text-white text-sm mb-2">
                            <input type="text" id="formImageUrl" class="w-full px-4 py-2 bg-[#201d13] border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary" placeholder="Or paste image URL here">
                        </div>
                        <div>
                            <label class="block text-white/80 text-sm font-medium mb-2">Audio MP3 (File or URL) *</label>
                            <input type="file" id="formAudioFile" accept="audio/*,.mp3" class="w-full px-4 py-2 bg-[#201d13] border border-white/10 rounded-lg text-white text-sm mb-2">
                            <input type="text" id="formAudioUrl" class="w-full px-4 py-2 bg-[#201d13] border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary" placeholder="Or paste audio URL here">
                        </div>
                        <div>
                            <label class="block text-white/80 text-sm font-medium mb-2">Duration</label>
                            <input type="text" id="formDuration" class="w-full px-4 py-2 bg-[#201d13] border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary" placeholder="3:45">
                        </div>
                        <div>
                            <label class="block text-white/80 text-sm font-medium mb-2">Description</label>
                            <textarea id="formDescription" rows="3" class="w-full px-4 py-2 bg-[#201d13] border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary" placeholder="Description"></textarea>
                        </div>
                        <div class="flex gap-3">
                            <button type="submit" class="flex-1 py-2 px-4 rounded-lg font-bold cursor-pointer bg-primary text-[#201d13] hover:bg-yellow-500 transition-colors">Add Mezmur</button>
                            <button type="button" id="cancelBtn" class="px-4 py-2 rounded-lg border border-white/20 text-white hover:bg-white/10 transition-colors">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('closeModal').addEventListener('click', () => modal.remove());
            document.getElementById('cancelBtn').addEventListener('click', () => modal.remove());
            document.getElementById('mezmurForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addMezmurWithForm(modal);
            });
        }

        async function addMezmurWithForm(modal) {
            const title = document.getElementById('formTitle').value.trim();
            const artist = document.getElementById('formArtist').value.trim();
            const category = document.getElementById('formCategory').value;
            const duration = document.getElementById('formDuration').value.trim() || '0:00';
            const description = document.getElementById('formDescription').value.trim() || '';
            const imageFile = document.getElementById('formImageFile').files[0];
            const audioFile = document.getElementById('formAudioFile').files[0];
            const imageUrl = document.getElementById('formImageUrl').value.trim();
            const audioUrl = document.getElementById('formAudioUrl').value.trim();

            if (!title || !artist) {
                alert('Please fill in title and artist');
                return;
            }

            if (!audioFile && !audioUrl) {
                alert('Please provide an audio file or URL');
                return;
            }

            if (!imageFile && !imageUrl) {
                alert('Please provide an image file or URL');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('title', title);
                formData.append('artist', artist);
                formData.append('category', category);
                formData.append('duration', duration);
                if (description) formData.append('description', description);

                // Always append URL fields, even if empty (helps with debugging)
                if (imageFile) {
                    formData.append('image', imageFile);
                }
                if (imageUrl) {
                    formData.append('imageUrl', imageUrl);
                }

                if (audioFile) {
                    formData.append('audio', audioFile);
                }
                if (audioUrl) {
                    formData.append('audioUrl', audioUrl);
                }

                const headers = getHeaders();
                delete headers['Content-Type']; // Let browser set it for FormData

                const r = await fetch(`${API_URL}/api/mezmurs`, {
                    method: 'POST',
                    headers: {
                        'Authorization': headers['Authorization']
                    },
                    body: formData
                });

                const res = await r.json();
                if (res.success) {
                    alert('✅ Mezmur added successfully!');
                    modal.remove();
                    loadMezmurs();
                } else {
                    alert('❌ Error: ' + (res.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Upload error:', e);
                alert('❌ Error: ' + e.message);
            }
        }

        async function addMezmur(data) {
            try {
                const r = await fetch(`${API_URL}/api/mezmurs`,{method:'POST',headers:getHeaders(),body:JSON.stringify(data)});
                const res = await r.json();
                if (res.success) { alert('✅ Added!'); loadMezmurs(); } else alert('❌ Error: '+(res.error||'Unknown'));
            } catch(e) { alert('❌ Error: '+e.message); }
        }

        function showAddWallpaperForm() {
            const ex = {title:"Ethiopian Orthodox Cross",category:"Icons",imageUrl:"https://example.com/wallpaper.jpg",thumbnailUrl:"https://example.com/wallpaper-thumb.jpg",tags:["cross","orthodox"]};
            const fd = prompt(`Enter wallpaper data as JSON:\n\nExample:\n${JSON.stringify(ex,null,2)}\n\nPaste your JSON:`,JSON.stringify(ex,null,2));
            if (fd) try { addWallpaper(JSON.parse(fd)); } catch(e) { alert('Invalid JSON: '+e.message); }
        }

        async function addWallpaper(data) {
            try {
                const r = await fetch(`${API_URL}/api/wallpapers`,{method:'POST',headers:getHeaders(),body:JSON.stringify(data)});
                const res = await r.json();
                if (res.success) { alert('✅ Added!'); loadWallpapers(); } else alert('❌ Error: '+(res.error||'Unknown'));
            } catch(e) { alert('❌ Error: '+e.message); }
        }

        function showAddRingtoneForm() {
            const ex = {title:"Church Bell",artist:"Traditional",category:"Bells",thumbnailUrl:"https://example.com/thumb.jpg",audioUrl:"https://example.com/ringtone.mp3",duration:"0:30",description:"Ethiopian Orthodox church bell"};
            const fd = prompt(`Enter ringtone data as JSON:\n\nExample:\n${JSON.stringify(ex,null,2)}\n\nPaste your JSON:`,JSON.stringify(ex,null,2));
            if (fd) try { addRingtone(JSON.parse(fd)); } catch(e) { alert('Invalid JSON: '+e.message); }
        }

        async function addRingtone(data) {
            try {
                const r = await fetch(`${API_URL}/api/ringtones`,{method:'POST',headers:getHeaders(),body:JSON.stringify(data)});
                const res = await r.json();
                if (res.success) { alert('✅ Added!'); loadRingtones(); } else alert('❌ Error: '+(res.error||'Unknown'));
            } catch(e) { alert('❌ Error: '+e.message); }
        }

        async function deleteMezmur(id) {
            if (!confirm('Delete this mezmur?')) return;
            try {
                const r = await fetch(`${API_URL}/api/mezmurs/${id}`,{method:'DELETE',headers:getHeaders()});
                const res = await r.json();
                if (res.success || r.ok) { alert('✅ Deleted!'); loadMezmurs(); } else alert('❌ Error: '+(res.error||'Delete failed'));
            } catch(e) { alert('❌ Error: '+e.message); }
        }

        async function deleteWallpaper(id) {
            if (!confirm('Delete this wallpaper?')) return;
            try {
                const r = await fetch(`${API_URL}/api/wallpapers/${id}`,{method:'DELETE',headers:getHeaders()});
                const res = await r.json();
                if (res.success || r.ok) { alert('✅ Deleted!'); loadWallpapers(); } else alert('❌ Error: '+(res.error||'Delete failed'));
            } catch(e) { alert('❌ Error: '+e.message); }
        }

        async function deleteRingtone(id) {
            if (!confirm('Delete this ringtone?')) return;
            try {
                const r = await fetch(`${API_URL}/api/ringtones/${id}`,{method:'DELETE',headers:getHeaders()});
                const res = await r.json();
                if (res.success || r.ok) { alert('✅ Deleted!'); loadRingtones(); } else alert('❌ Error: '+(res.error||'Delete failed'));
            } catch(e) { alert('❌ Error: '+e.message); }
        }

        window.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginBtn').addEventListener('click', (e) => { e.preventDefault(); login(); });
            ['email','password'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('keypress', (e) => { if (e.key === 'Enter') login(); });
            });
            document.getElementById('nav-mezmurs').addEventListener('click', () => showTab('mezmurs'));
            document.getElementById('nav-wallpapers').addEventListener('click', () => showTab('wallpapers'));
            document.getElementById('nav-ringtones').addEventListener('click', () => showTab('ringtones'));
            document.getElementById('nav-stats').addEventListener('click', () => showTab('stats'));
            document.getElementById('sidebarLogoutBtn').addEventListener('click', logout);
            document.getElementById('addItemBtn').addEventListener('click', () => {
                if (currentTab === 'mezmurs') showAddMezmurForm();
                else if (currentTab === 'wallpapers') showAddWallpaperForm();
                else if (currentTab === 'ringtones') showAddRingtoneForm();
            });
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.delete-mezmur-btn, .delete-wallpaper-btn, .delete-ringtone-btn');
                if (btn) {
                    const id = btn.getAttribute('data-id');
                    if (btn.classList.contains('delete-mezmur-btn')) deleteMezmur(id);
                    else if (btn.classList.contains('delete-wallpaper-btn')) deleteWallpaper(id);
                    else if (btn.classList.contains('delete-ringtone-btn')) deleteRingtone(id);
                }
            });
            if (authToken) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                loadContent();
            }
        });
    </script>
</body>
</html>